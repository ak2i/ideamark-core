# IdeaMark Core アーキテクチャ要件定義

このドキュメントは、IdeaMark コアライブラリのアーキテクチャ要件を定義します。CLIアプリケーション、MCP Server、各種Agent等の応用層が共通利用できる拡張可能な設計を目指します。詳細な実装仕様については [ideamark_core_architecture_spec.md](./ideamark_core_architecture_spec.md) を参照してください。

## 1. 全体アーキテクチャ要件

```
┌─────────────────────────────────────────────────────────────┐
│                    Application Layer                        │
├───────────────┬───────────────┬───────────────┬─────────────┤
│   CLI App     │  App Server   │  MCP Server   │ Agent Apps  │
│ (interactive  │ (multi-user + │ (LLM chat +   │ (automated +│
│  commands)    │  web UI)      │  REST API)    │ monitoring) │
└───────────────┴───────────────┴───────────────┴─────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   Service Layer                             │
├─────────────────────┬─────────────────────┬─────────────────┤
│  Discussion Service │ Versioning Service  │ Search Service  │
│  - extend議論管理   │ - compare差分計算   │ - search全機能  │
│  - セッション管理   │ - 履歴追跡          │ - index/vocab   │
├─────────────────────┼─────────────────────┼─────────────────┤
│Document Processing │  Analytics Service  │Link Management  │
│Service              │  - analyze統計      │Service          │
│  - breakdown分解    │  - 傾向可視化       │  - attach外部   │
│  - 構造検証         │  - ダッシュボード   │  - リンク管理   │
└─────────────────────┴─────────────────────┴─────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     Core Layer                              │
├─────────────────────┬─────────────────────┬─────────────────┤
│  IdeaMark Core      │    LLM Interface    │  Storage Layer  │
│  - Document管理     │  - Provider抽象化   │ - File/DB管理   │
│  - refs処理         │  - 設定統一管理     │ - シリアライゼ   │
│  - 基本操作         │  - レスポンス正規化 │ - バックアップ   │
└─────────────────────┴─────────────────────┴─────────────────┘
```

### 1.1 設計原則と採用理由

- **レイヤード アーキテクチャ**: 
  - **要件**: 各レイヤーが明確な責務を持ち、上位レイヤーのみ下位レイヤーに依存すること
  - **理由**: 責務の分離により、各コンポーネントの開発・テスト・メンテナンスが容易になる。また、依存関係が明確になり、影響範囲が限定される

- **拡張性**: 
  - **要件**: 新しいLLMプロバイダー、ストレージ、アプリケーション等を容易に追加可能にすること
  - **理由**: LLM技術の急速な進化に対応するため。また、多様なユースケースに対応できる柔軟性を確保するため

- **再利用性**: 
  - **要件**: コア機能を複数のアプリケーションで共有すること
  - **理由**: コード重複を避け、一貫性を保ち、開発・メンテナンスの効率化を実現するため

- **設定統一**: 
  - **要件**: 全コンポーネントで共通の設定管理を行うこと
  - **理由**: 設定の一元管理により、一貫性のある動作と簡潔な管理を実現するため

- **テスタビリティ**: 
  - **要件**: 各レイヤーが独立してテスト可能であること
  - **理由**: 品質担保、回帰テストの容易化、継続的な開発・改善を支援するため

## 2. アプリケーションレイヤーの要件

### 2.1 CLI App

- **目的**: 対話的なコマンドライン操作によるIdeaMarkドキュメントの管理
- **必要な理由**: 
  - 開発者・研究者向けの詳細な制御を提供する必要がある
  - スクリプトやバッチ処理との連携を可能にするため
  - GUIなしの環境でも操作可能にするため
- **特徴**: 
  - 単一ユーザー、ローカル実行
  - 全IdeaMarkコマンドを直接実行
  - シンプルで高速な操作性
- **主要機能**: create, extend, merge, search, analyze, compare等

### 2.2 App Server

- **目的**: マルチユーザー対応のWebアプリケーション
- **必要な理由**:
  - チーム作業を支援するため
  - ブラウザベースの操作性を提供するため
  - 可視化やダッシュボードなどの高度なUIを実現するため
- **特徴**:
  - Web UI提供
  - ユーザー認証・権限管理
  - ダッシュボード・レポート機能
  - チーム協働機能
- **主要機能**: プロジェクト管理、可視化、共有、履歴管理

### 2.3 MCP Server

- **目的**: LLM Chatサービス向けのModel Context Protocol実装
- **必要な理由**:
  - LLMとの自然な対話でIdeaMarkを操作できるようにするため
  - 最新のLLM統合プロトコルに対応するため
  - チャットベースのAIアシスタントをサポートするため
- **特徴**:
  - LLM向けに最適化されたREST API
  - MCP仕様準拠のツール提供
  - チャット形式でのIdeaMarkドキュメント操作
- **主要機能**: LLM向けツールセット、コンテキスト提供、結果フォーマット

### 2.4 Agent Apps

- **目的**: 自動化・監視機能を提供する常駐アプリケーション
- **必要な理由**:
  - 定期的な処理や監視を自動化するため
  - バックグラウンドでの処理を実現するため
  - 人間の介入なしに対応可能なタスクを効率化するため
- **特徴**:
  - バックグラウンド実行
  - スケジュールベース処理
  - 外部システム連携
  - 監視・アラート機能
- **主要機能**: 定期分析、品質監視、自動レポート、通知

## 3. サービスレイヤーの要件

### 3.1 Discussion Service

- **目的**: 複数ユーザーによる議論やセッション管理
- **必要な理由**:
  - ドキュメントに関する議論を一元管理するため
  - 変更履歴とその背景を追跡可能にするため
  - AI支援による議論促進を実現するため
- **主要機能**:
  - セッション管理
  - メッセージスレッド追跡
  - AIアシスタント連携

### 3.2 Versioning Service

- **目的**: IdeaMarkのrefsを活用したバージョン管理と差分計算
- **必要な理由**:
  - ドキュメントの変更履歴を追跡するため
  - 複数バージョン間の違いを明確にするため
  - 並行開発や分岐・マージをサポートするため
- **主要機能**:
  - バージョン履歴追跡
  - 差分計算
  - マージ機能

### 3.3 Search Service

- **目的**: インデックス構築、検索、タグ管理
- **必要な理由**:
  - 大量のドキュメントから必要な情報を素早く見つけるため
  - 意味的に関連するドキュメントを発見するため
  - 検索体験の最適化と検索精度向上のため
- **主要機能**:
  - 全文検索
  - タグベース検索
  - 意味検索・類義語展開

### 3.4 Document Processing Service

- **目的**: ドキュメントの分解・検証・マージ
- **必要な理由**:
  - 抽象的な概念を具体的な実装に分解するため
  - ドキュメント構造の整合性を確保するため
  - 複数のサブドキュメントを統合管理するため
- **主要機能**:
  - 構造分解（breakdown）
  - 形式検証
  - ドキュメント統合

### 3.5 Analytics Service

- **目的**: ドキュメント群の分析と可視化
- **必要な理由**:
  - ドキュメント間の関係性を理解するため
  - 傾向や不足部分を特定するため
  - データ駆動の意思決定をサポートするため
- **主要機能**:
  - 統計分析
  - 傾向可視化
  - ギャップ検出

### 3.6 Link Management Service

- **目的**: 外部リソースの紐付けと管理
- **必要な理由**:
  - 外部情報との連携を実現するため
  - 参照整合性を維持するため
  - コンテキストを豊かにするため
- **主要機能**:
  - 外部リンク管理
  - リンク検証
  - 同期機能

## 4. コアレイヤーの要件

### 4.1 IdeaMark Core

- **目的**: ドキュメント基本操作と構造管理
- **必要な理由**:
  - 一貫したドキュメント操作APIを提供するため
  - ドキュメント構造の整合性を保証するため
  - すべてのアプリケーションの基盤となるため
- **主要機能**:
  - ドキュメントCRUD操作
  - refs処理
  - スキーマ検証

### 4.2 LLM Interface

- **目的**: 外部LLMとの統一インターフェース
- **必要な理由**:
  - 複数のLLMプロバイダーに対応するため
  - プロバイダー切り替えを容易にするため
  - 各プロバイダーの特性を抽象化するため
- **主要機能**:
  - プロバイダー抽象化
  - プロンプト管理
  - レスポンス正規化

### 4.3 Storage Layer

- **目的**: ドキュメント永続化の抽象化
- **必要な理由**:
  - 複数のストレージバックエンドに対応するため
  - ストレージ形式の詳細から上位レイヤーを分離するため
  - 将来的なスケーリングに備えるため
- **主要機能**:
  - ファイルストレージ
  - データベースストレージ
  - バックアップ・復元

## 5. 実装優先度

アーキテクチャの段階的実装を以下の優先度で進めるべき理由：

### Phase 1: Core Foundation
- **優先理由**: すべての機能の基盤となるため、最初に実装する必要がある
- **主な構成要素**: 
  - 基本的なLLM Interface実装: 外部AIとの連携基盤
  - File Storage実装: ドキュメントの永続化基盤
  - Config Management: 設定の一元管理基盤
  - CLI基本コマンド: 開発・検証用の基本機能

### Phase 2: Core Services
- **優先理由**: 基本機能の上に構築される中核サービスを提供するため
- **主な構成要素**:
  - Versioning Service: 履歴管理の基盤
  - Search Service拡張: 情報検索の強化
  - Document Processing: ドキュメント処理の基盤
  - Agent Library基礎: 自動化の基盤

### Phase 3: Advanced Features
- **優先理由**: 高度な機能を段階的に追加し、ユーザー体験を向上させるため
- **主な構成要素**:
  - Discussion Service: 協働機能の強化
  - Analytics Service: データ駆動の意思決定支援
  - Link Management: 外部連携の強化
  - MCP Server: AI連携の強化

### Phase 4: Production Ready
- **優先理由**: 本番環境での安定運用のため
- **主な構成要素**:
  - Database Storage: スケーラビリティ向上
  - イベント駆動・プラグイン: 拡張性向上
  - 監視・ログ: 運用安定性向上
  - パフォーマンス最適化: 効率化

## 6. 機能とアーキテクチャの対応関係

各機能とアーキテクチャコンポーネントの関連付けにより、以下の利点がある：

- 責務の明確化: 各機能の実装責任が明確になる
- 依存関係の可視化: コンポーネント間の連携が明確になる
- ギャップ検出: 機能とアーキテクチャのミスマッチを早期に発見できる

詳細な機能の実装仕様については、[ideamark_core_architecture_spec.md](./ideamark_core_architecture_spec.md)を参照してください。
